---
layout: post
title:  "Включаем exactly once delivery в kafka приложении"
date:   2019-05-10 13:20:34 +0300
tags: rus kafka
---
В сети очень много информации о Kafka, особенно теоритических разборов тех или иных ее особенностей.
Одной из особенностей Kafka является [exactly once delivery](https://cwiki.apache.org/confluence/display/KAFKA/KIP-98+-+Exactly+Once+Delivery+and+Transactional+Messaging#KIP-98-ExactlyOnceDeliveryandTransactionalMessaging-IdempotentProducerGuarantees), которая появилась в ней начиная с версии 0.11.
По умолчанию эта возможность является выключенной и отличительной ее особенностью вляется то, что ее нужно конфигурировать как на Producer (приложение, которое отправляет сообщения) так и на Consumer (приложение, которое читает сообщения). Далее я хочу разобрать настройки, которые позволят сконфигурировать эту возможности.

Для начала изменим на Consumer значение параметра `isolation.level`.
Эта настройка имеет по умолчанию значение `read_uncommitted`. Это значит, что Consumer считает сообщение из топика как только оно в нем появится. При этом если Producer, положивший это сообщение, откатит транзакцию и попытается повторить процесс отправки, то Consumer получит дубликат ранее обработанного сообщения. Чтобы предотвратить чтение uncommitted сообщений необходимо выставить `isolation.level` в `read_committed`. Однако, Consumer с `isolation.level=read_committed` сможет читать сообщения из топика даже от не транзакционных Producer-ов.

Теперь изменим параметры Producer-а.
Наша цель - включить поддержку транзакций. Для этого должны быть соблюдены следующие условия:
1. `max.in.flight.requests.per.connection` должно быть <= 5. Значение по умолчанию удовлетворяет этому условию.
2. `acks` должен быть равен `all` (значение по умолчанию 1). Этот параметр отвечает за количество acknowledgments сообщений, полученных лидером kafka кластера, перед отправкой подтверждения записи на Producer. Значение `all` говорит о том, что все узлы kafka кластера должны подтвердить получение сообщения.
3. `retries` должно иметь значение > 0 (по умолчанию 0). Значение этого параметра показывает, сколько раз Producer должен повторить отправку сообщения в случае возникновения проблем на kafka кластере.
4. `enable.idempotence` необходимо выставить в `true` (по умолчанию false). Идемпотентность гарантирует, что сообщение, которое записывается в топик, не будет дублироватся в рамках стрима.
Такое может произойти, например, во время ретраев на Producer, когда сообщение было записано в кластер, а подтверждение об этом потерялось.
5. Теперь мы можем включить поддержку транзакций путем присвоения значения для параметра `transactional.id` (по умолчанию null). Необходимо гарантировать уникальность значения `transactional.id` даже для разных экземпляров одного и того же приложения. В противном случае
kafka может посчитать первый запущенный экземпляр приложения зомби процессом и его работа будет нарушена. Для этого, например, можно добавить в `transactional.id` идентификатор хоста, на котором запущено приложение.

После того, как транзакционный Producer настроен, осталось только добавить транзакционную отправку сообщений в ваш код. Например в spring для этого можно воспользоваться аннотацией `@Transactional` с указанием имени бина типа KafkaTransactionManager или использовать TransactionTemplate, если вы не любите AOP.